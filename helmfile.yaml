repositories:
  - name: dopc02devops-repo
    url: "https://dopc02devops.github.io/helms_artifacts/"

hooks:
  - events: ["prepare"] # Runs before any helmfile operation
    command: "bash"
    args:
      - "-c"
      - |
        # Define download folder
        DOWNLOAD_FOLDER="./helms_artifacts"
        
        # Package and index charts
        for chart in ./dynamodbchart ./chartpostgress ./bookchart ./employeechart ./chartnginx; do
          helm lint $chart
          helm package $chart -d $DOWNLOAD_FOLDER
        done

        helm repo index $DOWNLOAD_FOLDER --url https://dopc02devops.github.io/helms_artifacts/

        # Update dependencies
        for chart in bookchart employeechart chartnginx; do
          helm dependency update $chart -n dev
        done
        
        # Git operations
        cd $DOWNLOAD_FOLDER
        commit_message=${1:-"Auto-committed helm artifacts on $(date)"}
        git add .
        git commit -m "$commit_message"
        git push
        echo "Changes have been pushed to the remote repository."

  - events: ["post-install"] # send notifications for example slack
    command: "bash"
    args:
      - "-c"
      - |
        echo "Release myapp installed successfully in the dev namespace."
        kubectl get pods -n dev
        

releases:
  - name: dynamodb
    chart: ./dynamodbchart
    namespace: dev
    installed: true
    values:
      - ./dynamodbchart/values.yaml

  - name: postgress
    chart: ./chartpostgress
    namespace: dev
    installed: true
    values:
      - ./chartpostgress/values.yaml

  - name: book
    chart: ./bookchart
    namespace: dev
    installed: true
    values:
      - ./bookchart/values.yaml

  - name: employee
    chart: ./employeechart
    namespace: dev
    installed: true
    values:
      - ./employeechart/values.yaml

  - name: employee-book-api
    chart: ./chartnginx
    namespace: dev
    installed: true
    values:
      - ./chartnginx/values.yaml
